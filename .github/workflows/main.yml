name: Build Blender 4.2 ARM64 + DEB Package

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-blender:
    runs-on: ubuntu-24.04-arm

    steps:
      # -------------------------------------------------------
      # 1. Checkout Blender source
      # -------------------------------------------------------
      - name: Checkout Blender
        uses: actions/checkout@v4
        with:
          repository: blender/blender
          ref: blender-v4.2-release
          submodules: recursive

      # -------------------------------------------------------
      # 2. Install ccache
      # -------------------------------------------------------
      - name: Install ccache
        run: sudo apt-get update && sudo apt-get install -y ccache

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-blender-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-blender-

      - name: Setup ccache env
        run: |
          echo 'export CC="ccache gcc"' >> $GITHUB_ENV
          echo 'export CXX="ccache g++"' >> $GITHUB_ENV
          echo 'export CCACHE_DIR=~/.cache/ccache' >> $GITHUB_ENV
          echo 'export CCACHE_MAXSIZE=10G' >> $GITHUB_ENV

      # -------------------------------------------------------
      # 3. Cache Blender precompiled deps
      # -------------------------------------------------------
      - name: Cache Blender deps
        uses: actions/cache@v4
        with:
          path: |
            build_linux_aarch64/deps
            lib
          key: blender-deps-arm64-${{ hashFiles('build_files/**') }}
          restore-keys: |
            blender-deps-arm64-

      # -------------------------------------------------------
      # 4. Install system build dependencies
      # -------------------------------------------------------
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential automake autoconf wget cmake yasm ninja-build git \
            python3 python3-dev python3-pip \
            libxi-dev libxxf86vm-dev libxfixes-dev libxrender-dev \
            libx11-dev libxext-dev libpython3-dev \
            libjpeg-dev libpng-dev libtiff-dev \
            libopenexr-dev libpulse-dev libpipewire-0.3-dev \
            libfreetype6-dev libfontconfig1-dev \
            libepoxy-dev libgl1-mesa-dev libgles2-mesa-dev \
            libsqlite3-dev libtool-bin \
            libwayland-dev wayland-protocols \
            libxkbcommon-dev libasound2-dev libdbus-1-dev \
            libavcodec-dev libavformat-dev libavdevice-dev \
            libavutil-dev libswscale-dev libswresample-dev
          
      - name: Fix GLU source (pre-download)
        run: |
          mkdir -p /home/runner/work/Arm/build_linux/deps_aarch64/packages/
          if [ ! -f /home/runner/work/Arm/build_linux/deps_aarch64/packages/glu-9.0.1.tar.xz ]; then
            echo "Downloading GLU from HTTP mirror..."
            wget -q https://archive.mesa3d.org/glu/glu-9.0.1.tar.xz \
              -O /home/runner/work/Arm/build_linux/deps_aarch64/packages/glu-9.0.1.tar.xz
          else
            echo "GLU package already exists."
          fi

      - name: Fix MESA source (pre-download)
        run: |
          mkdir -p /home/runner/work/Arm/build_linux/deps_aarch64/packages/
          if [ ! -f /home/runner/work/Arm/build_linux/deps_aarch64/packages/mesa-23.3.0.tar.xz ]; then
            echo "Downloading MESA from HTTP mirror..."
            wget -q https://archive.mesa3d.org/mesa-23.3.0.tar.xz \
              -O /home/runner/work/Arm/build_linux/deps_aarch64/packages/mesa-23.3.0.tar.xz
          else
            echo "MESA package already exists."
          fi

      - name: Fix GMP source (pre-download)
        run: |
          mkdir -p /home/runner/work/Arm/build_linux/deps_aarch64/packages/
          if [ ! -f /home/runner/work/Arm/build_linux/deps_aarch64/packages/gmp-6.2.1.tar.xz ]; then
            echo "Downloading GMP from fast mirror..."
            wget -q https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz \
              -O /home/runner/work/Arm/build_linux/deps_aarch64/packages/gmp-6.2.1.tar.xz
          else
            echo "GMP package already exists."
          fi
          
      - name: Download libtool 2.4.7
        run: |
          wget https://ftp.gnu.org/gnu/libtool/libtool-2.4.7.tar.gz
          tar xf libtool-2.4.7.tar.gz

      - name: Build libtool 2.4.7
        run: |
          cd libtool-2.4.7
          ./configure
          make -j$(nproc)

      - name: Install libtool 2.4.7
        run: |
          cd libtool-2.4.7
          sudo make install
          sudo ldconfig

      - name: Check version
        run: libtool --version

      - name: Fix libtool macros for SQLite
        run: |
          SQLITE_DIR=$(find . -type d -path "*/external_sqlite" | head -n 1)
          echo "Found SQLite dir: $SQLITE_DIR"
          cd "$SQLITE_DIR"
          aclocal
          libtoolize --force
          autoreconf -fi

              
      # -------------------------------------------------------
      # 5. Build Blender deps (USD, OIIO, OSL, etc.)
      # -------------------------------------------------------
      - name: Build deps
        run: |
          if [ ! -d "build_linux_aarch64/deps/Release" ]; then
            make deps -j$(nproc)
          else
            echo "Deps cached â€” skipping build."
          fi

      # -------------------------------------------------------
      # 6. Build Blender release
      # -------------------------------------------------------
      - name: Build Blender
        run: |
          make release -j$(nproc)

      # -------------------------------------------------------
      # 7. Generate Blender DEB package via CPack
      # -------------------------------------------------------
      - name: Build .deb package
        run: |
          cd build_linux_aarch64
          cpack -G DEB

      # -------------------------------------------------------
      # 8. Upload artifacts (binary + .deb)
      # -------------------------------------------------------
      - name: Upload Blender Binary
        uses: actions/upload-artifact@v4
        with:
          name: blender-arm64-binary
          path: build_linux_aarch64/bin/blender

      - name: Upload Blender DEB Package
        uses: actions/upload-artifact@v4
        with:
          name: blender-arm64-deb
          path: build_linux_aarch64/*.deb
